<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mentalcream.demo.repository.StatsMapper">

    <select id="calculateRecoveryMetrics" resultType="map">
        SELECT
            (SELECT NVL(SUM(CASE category
                                WHEN 'PROJECT' THEN 3.0
                                WHEN 'STUDY' THEN 2.0
                                WHEN 'RUN' THEN 1.5
                                WHEN 'LIFE' THEN 1.0
                                ELSE 0 END), 0) 
             FROM done_item 
             WHERE log_date BETWEEN #{weekStart} AND #{weekEnd}) AS quality_score,
            (SELECT NVL(AVG(energy), 5.0) FROM daily_log WHERE log_date BETWEEN #{weekStart} AND #{weekStart} + 2) AS first_half_avg,
            (SELECT NVL(AVG(energy), 5.0) FROM daily_log WHERE log_date BETWEEN #{weekStart} + 3 AND #{weekEnd}) AS second_half_avg,
            (SELECT COUNT(*) FROM daily_log WHERE log_date BETWEEN #{weekStart} AND #{weekEnd}) AS log_count
        FROM DUAL
    </select>

    <select id="calculateTotalXp" resultType="long">
        SELECT NVL(SUM(CASE category
                        WHEN 'LIFE' THEN 5
                        WHEN 'STUDY' THEN 10
                        WHEN 'RUN' THEN 15
                        WHEN 'PROJECT' THEN 20
                        ELSE 0 END), 0)
        FROM done_item
    </select>

    <select id="calculateCurrentStreak" resultType="int">
        /* 오늘 또는 어제부터 시작하여 끊기지 않은 연속 일수 계산 */
        WITH RECURSIVE_DATES AS (
            SELECT MAX(log_date) as last_date
            FROM done_item
            WHERE log_date >= #{today} - 1
        )
        SELECT COUNT(DISTINCT log_date)
        FROM done_item
        WHERE log_date > (
            SELECT NVL(MAX(d), TO_DATE('1900-01-01', 'YYYY-MM-DD'))
            FROM (
                SELECT #{today} - LEVEL + 1 as d
                FROM DUAL
                CONNECT BY LEVEL &lt;= 1000 /* 최대 1000일까지만 체크 */
            ) dates
            LEFT JOIN (SELECT DISTINCT log_date FROM done_item) items ON dates.d = items.log_date
            WHERE items.log_date IS NULL AND dates.d &lt;= (SELECT last_date FROM RECURSIVE_DATES)
        )
    </select>

</mapper>
